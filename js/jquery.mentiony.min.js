/*
 * Contentediable Mentiony jQuery plugin
 * Version 0.1.0
 * Written by: Luat Nguyen(luatnd) on 2016/05/27
 *
 * Transform textarea or input into contentediable with mention feature.
 *
 * License: MIT License - http://www.opensource.org/licenses/mit-license.php
 */

var tmpEle=null;!function($){function getSelectionCoords(e){e=e||window;var t,n,o,i=e.document,r=i.selection,l=0,a=0;if(r)"Control"!=r.type&&(t=r.createRange(),t.collapse(!0),l=t.boundingLeft,a=t.boundingTop);else if(e.getSelection&&(r=e.getSelection(),r.rangeCount&&(t=r.getRangeAt(0).cloneRange(),t.getClientRects&&(t.collapse(!0),n=t.getClientRects(),n.length>0&&(o=n[0]),l=o.left,a=o.top),0==l&&0==a))){var s=i.createElement("span");if(s.getClientRects){s.appendChild(i.createTextNode("â€‹")),t.insertNode(s),o=s.getClientRects()[0],l=o.left,a=o.top;var p=s.parentNode;p.removeChild(s),p.normalize()}}return{x:l,y:a}}function getSelectionEndPositionInCurrentLine(){var e=0;if(window.getSelection){var t=window.getSelection();e=t.focusOffset}return e}var KEY={AT:64,BACKSPACE:8,DELETE:46,TAB:9,ESC:27,RETURN:13,LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,HOME:36,END:35,COMMA:188,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190};jQuery.fn.mentiony=function(e,t){var n={debug:0,containerPaddingPx:10,globalTimeout:null,timeOut:400,triggerChar:"@",onDataRequest:$.noop,popoverOffset:{x:-30,y:0},templates:{container:'<div id="mentiony-container-[ID]" class="mentiony-container"></div>',content:'<div id="mentiony-content-[ID]" class="mentiony-content" contenteditable="true"></div>',popover:'<div id="mentiony-popover-[ID]" class="mentiony-popover"></div>',list:'<ul id="mentiony-popover-[ID]" class="mentiony-list"></ul>',listItem:'<li class="mentiony-item" data-item-id=""><div class="row"><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3"><img src="https://avatars2.githubusercontent.com/u/1859127?v=3&s=140"></div><div class="pl0 col-xs-9 col-sm-9 col-md-9 col-lg-9"><p class="title">Company name</p><p class="help-block">Addition information</p></div></div></li>',normalText:'<span class="normal-text">&nbsp;</span>',highlight:'<span class="highlight"></span>',highlightContent:'<a href="[HREF]" data-item-id="[ITEM_ID]" class="mentiony-link">[TEXT]</a>'}};"object"!=typeof e&&e||(t=e);var o=$.extend({},n,t);return this.each(function(){var t=$.data(this,"mentiony")||$.data(this,"mentiony",new MentionsInput(o));return"function"==typeof t[e]?t[e].apply(this,Array.prototype.slice.call(outerArguments,1)):"object"!=typeof e&&e?void $.error("Method "+e+" does not exist"):t.init.call(this,this)})};var MentionsInput=function(settings){function initTextArea(e){if(elmInputBox=$(e),"true"!=elmInputBox.attr("data-mentions-input")){elmInputBox.attr("data-mentions-input","true"),0==elmInputBox.attr("id").length?(elmInputBoxId="mentiony-input-"+inputId,elmInputBox.attr("id",elmInputBoxId)):elmInputBoxId=elmInputBox.attr("id"),elmInputBoxInitialWidth=elmInputBox.prop("scrollWidth"),elmInputBoxInitialHeight=elmInputBox.prop("scrollHeight"),elmInputBoxContainer=$(settings.templates.container.replace("[ID]",inputId)),elmInputBoxContent=$(settings.templates.content.replace("[ID]",inputId)),elmInputBoxContainer.append(elmInputBox.clone().addClass("mention-input-hidden")),elmInputBoxContainer.append(elmInputBoxContent),elmInputBox.replaceWith(elmInputBoxContainer),popoverEle=$(settings.templates.popover.replace("[ID]",inputId)),list=$(settings.templates.list.replace("[ID]",inputId)),elmInputBoxContainer.append(popoverEle),popoverEle.append(list),elmInputBox=$("#"+elmInputBoxId);var t=parseInt(elmInputBoxContainer.css("padding"));elmInputBoxContainer.css({width:elmInputBoxInitialWidth+"px"}),elmInputBoxContent.width(elmInputBoxInitialWidth-2*t+"px"),elmInputBoxContent.css({minHeight:elmInputBoxInitialHeight+"px"}),elmInputBoxContentAbsPosition=elmInputBoxContent.offset(),editableContentLineHeightPx=parseInt($(elmInputBoxContent.css("line-height")).selector),elmInputBoxContent.bind("keydown",onInputBoxKeyDown),elmInputBoxContent.bind("keypress",onInputBoxKeyPress),elmInputBoxContent.bind("input",onInputBoxInput),elmInputBoxContent.bind("keyup",onInputBoxKeyUp),elmInputBoxContent.bind("click",onInputBoxClick)}}function onInputBoxKeyDown(e){return events={keyDown:!0,keyPress:!1,input:!1,keyup:!1},dropDownShowing?handleUserChooseOption(e):void 0}function onInputBoxKeyPress(e){events.keyPress=!0,needMention||(needMention=e.keyCode===KEY.AT)}function onInputBoxInput(){events.input=!0}function onInputBoxKeyUp(e){events.keyup=!0,events.input&&updateDataInputData(e),needMention&&(e.keyCode===KEY.RETURN||!events.input&&e.keyCode!==KEY.LEFT&&e.keyCode!==KEY.RIGHT||(updateMentionKeyword(e),doSearchAndShow()))}function onInputBoxClick(e){needMention&&(updateMentionKeyword(e),doSearchAndShow())}function onListItemClick(e){setSelectedMention($(this)),choseMentionOptions(!0)}function updateDataInputData(e){var t=elmInputBoxContent.html();elmInputBox.val(t),log(elmInputBox.val(),"elmInputBoxText : "),tmpEle=elmInputBox}function doSearchAndShow(){settings.timeOut>0?(null!==settings.globalTimeout&&clearTimeout(settings.globalTimeout),settings.globalTimeout=setTimeout(function(){settings.globalTimeout=null,settings.onDataRequest.call(this,"search",currentMention.keyword,onDataRequestCompleteCallback)},settings.timeOut)):settings.onDataRequest.call(this,"search",currentMention.keyword,onDataRequestCompleteCallback)}function populateDropdown(e,t){list.empty(),currentMention.jqueryDomNode=null,currentMention.mentionItemDataSet=t,t.length?(currentMention.charAtFound===!0&&showDropDown(),t.forEach(function(e,t){var n=$(settings.templates.listItem);n.attr("data-item-id",e.id),n.find("img:first").attr("src",e.avatar),n.find("p.title:first").html(e.name),n.find("p.help-block:first").html(e.info),n.bind("click",onListItemClick),list.append(n)})):hideDropDown()}function showDropDown(){var e=getSelectionCoords();dropDownShowing=!0,popoverEle.css({display:"block",top:e.y-(elmInputBoxContentAbsPosition.top-$(document).scrollTop())+(editableContentLineHeightPx+10),left:e.x-elmInputBoxContentAbsPosition.left})}function hideDropDown(){dropDownShowing=!1,popoverEle.css({display:"none"})}function handleUserChooseOption(e){return dropDownShowing?e.keyCode===KEY.UP||e.keyCode===KEY.DOWN?(choosingMentionOptions(e),!1):e.keyCode===KEY.HOME||e.keyCode===KEY.RETURN||e.keyCode===KEY.TAB?(choseMentionOptions(),!1):!0:!0}function updateMentionKeyword(e){if(document.selection)var t=document.selection.createRange();else var t=window.getSelection().anchorNode;var n=t.data,o=getSelectionEndPositionInCurrentLine();currentMention.lastActiveNode=t,currentMention.keyword="";for(var i=o-1,r=!0;r;){var l=n.charAt(i);(""===l||l===settings.triggerChar)&&(r=!1),i--}currentMention.keyword=n.substring(i+1,o),-1===currentMention.keyword.indexOf(settings.triggerChar)?(currentMention.keyword="",currentMention.charAtFound=!1,hideDropDown()):(currentMention.keyword=currentMention.keyword.substring(1,o),currentMention.charAtFound=!0),log(currentMention.keyword,"currentMention.keyword")}function getMentionKeyword(){return currentMention.keyword}function setSelectedMention(e){currentMention.jqueryDomNode=e,updateSelectedMentionUI(e),log(e,"setSelectedMention item: ")}function updateSelectedMentionUI(e){$.each(list.children(),function(e,t){$(t).removeClass("active")}),e.addClass("active")}function choosingMentionOptions(e){log("choosingMentionOptions"),null===currentMention.jqueryDomNode&&setSelectedMention(list.children().first());var t=[];e.keyCode===KEY.DOWN?t=currentMention.jqueryDomNode.next():e.keyCode===KEY.UP&&(t=currentMention.jqueryDomNode.prev()),0===t.length&&(t=currentMention.jqueryDomNode),setSelectedMention(t)}function choseMentionOptions(e){"undefined"===e&&(e=!1),log("choosedMentionOptions by "+(e?"Mouse":"Keyboard"));for(var t={},n=currentMention.jqueryDomNode.attr("data-item-id"),o=0,i=currentMention.mentionItemDataSet.length;i>o;o++)if(n==currentMention.mentionItemDataSet[o].id){t=currentMention.mentionItemDataSet[o];break}var r=$(settings.templates.highlight),l=$(settings.templates.highlightContent.replace("[HREF]",t.href).replace("[TEXT]",t.name).replace("[ITEM_ID]",t.id));r.append(l),replaceTextInRange("@"+currentMention.keyword,r.prop("outerHTML"),e),log("Finish mention","","warn"),needMention=!1,currentMention.keyword="",hideDropDown(),updateDataInputData()}function log(msg,prefix,level){"undefined"==typeof level&&(level="log"),1===settings.debug&&eval("console."+level+"(inputId, prefix ? prefix + ':' : '', msg);")}function replaceTextInRange(e,t,n){var o,i={startBefore:0,startAfter:0,stopBefore:0,stopAfter:0},r=window.getSelection();if("undefined"!==n&&n===!0){var l=currentMention.lastActiveNode;o=document.createRange(),o.setStart(l,l.data.length),o.collapse(!0),r.removeAllRanges(),r.addRange(o)}var a=!1,s=r.focusOffset,p=s-e.length;window.getSelection?(a=!1,r=window.getSelection(),r.rangeCount>0&&(o=r.getRangeAt(0).cloneRange(),o.collapse(!0))):(r=document.selection)&&"Control"!=r.type&&(o=r.createRange(),a=!0),p!==s&&(o.setStart(r.anchorNode,p),o.setEnd(r.anchorNode,s),o.deleteContents());var u=document.createElement("span");u.setAttribute("class","mention-area"),u.innerHTML=t,o.insertNode(u),o.setEnd(r.focusNode,o.endContainer.length),i.startBefore=p,i.stopBefore=s,i.startAfter=p,i.stopAfter=p+u.innerText.length;var d=!1;for(u=$(r.anchorNode);!d;)0===u.next().text().length?d=!0:u=u.next();var c=$(settings.templates.normalText).insertAfter(u);return o=document.createRange(),o.setStartAfter(c.get(0)),o.setEndAfter(c.get(0)),r.removeAllRanges(),r.addRange(o),i}var elmInputBoxContainer,elmInputBoxContent,elmInputBox,elmInputBoxInitialWidth,elmInputBoxInitialHeight,editableContentLineHeightPx,popoverEle,list,elmInputBoxId,elmInputBoxContentAbsPosition={top:0,left:0},dropDownShowing=!1,events={keyDown:!1,keyPress:!1,input:!1,keyup:!1},currentMention={keyword:"",jqueryDomNode:null,mentionItemDataSet:[],lastActiveNode:0,charAtFound:!1},needMention=!1,inputId=Math.random().toString(36).substr(2,6),onDataRequestCompleteCallback=function(e){populateDropdown(currentMention.keyword,e)};return{init:function(e){initTextArea(e)}}}}(jQuery);
